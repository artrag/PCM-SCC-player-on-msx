Sjasm Z80 Assembler v0.42c - www.xl2s.tk             [2018.02.03 - 12:44:28]

SccReplayer3c.asm
Errors: 5

       1   00:0000                      ;----------------------------------------------------------------------------
       2   00:0000                      ;----------------------------------------------------------------------------
       3   00:0000                      
       4   00:0000                              output "sccplay3c.rom"
       5   00:4000                      
       6   00:4000                              org 4000h
       7   00:4000                              dw  4241h,START,0,0,0,0,0,0
       7   00:4000  41 42 10 40 00 00 00 00 00 00 00 00 00 00 00 00 
       8   00:4010                      
       9   00:4010                      ;	Bank 1: 6000h - 67FFh (6000h used)
      10   00:4010                      ;	Bank 2: 6800h - 6FFFh (6800h used)
      11   00:4010                      ;	Bank 3: 7000h - 77FFh (7000h used)
      12   00:4010                      ;	Bank 4: 7800h - 7FFFh (7800h used)
      13   00:4010                      
      14   00:4010                      
      15   00:4010                      ; ascii-8 mapper
      16   00:4010                      
      17   00:4010  (00:6000)           Bank1:  equ      6000h
      18   00:4010  (00:6800)           Bank2:  equ      6800h
      19   00:4010  (00:7000)           Bank3:  equ      7000h
      20   00:4010  (00:7800)           Bank4:  equ      7800h
      21   00:4010                      
      22   00:4010                      ; scc mapper for scc chip
      23   00:4010                      
      24   00:4010  (00:9000)           sccBank3:  equ      09000h
      25   00:4010                      
      26   00:4010                      ;-------------------------------------
      27   00:4010                      ; Entry point
      28   00:4010                      ;-------------------------------------
      29   00:4010                      START:
      30   00:4010  3E 28                       ld		a,40
      31   00:4012  32 AE F3            		ld		(0xF3AE),a	; screen width
      32   00:4015  AF                          xor     a
      33   00:4016  CD 5F 00                    call    005Fh
      34   00:4019  AF                          xor     a
      35   00:401A  32 DB F3            		ld		(0xF3DB),a	; no key click
      36   00:401D  CD D0 42            		call	init_mapper
      37   00:4020                      
      38   00:4020  CD D4 43            		call	search_slot
      39   00:4023  11 68 01            		ld		de,40*9
      40   00:4026  21 11 41            		ld		hl,rom_slot_text
      41   00:4029  CD DA 40            		call	message
      42   00:402C  11 72 01                    ld      de,40*9+10
      43   00:402F  2A 0C D0            		ld		hl,(slotvar)
      44   00:4032  26 00               		ld		h,0
      45   00:4034  CD E1 42                    call    PrintNum
      46   00:4037                      
      47   00:4037  CD F3 43            		call	search_slotram
      48   00:403A  11 90 01            		ld		de,40*10
      49   00:403D  21 1C 41            		ld		hl,ram_slot_text
      50   00:4040  CD DA 40            		call	message
      51   00:4043  11 9A 01                    ld      de,40*10+10
      52   00:4046  2A 0E D0            		ld		hl,(slotram)
      53   00:4049  26 00               		ld		h,0
      54   00:404B  CD E1 42                    call    PrintNum
      55   00:404E                      
      56   00:404E  CD 36 45                    call    SCCsearch
      57   00:4051  11 40 01            		ld		de,40*8
      58   00:4054  21 06 41            		ld		hl,scc_slot_text
      59   00:4057  CD DA 40            		call	message
      60   00:405A  11 4A 01                    ld      de,40*8+10
      61   00:405D  2A 10 D0            		ld		hl,(SCC)
      62   00:4060  26 00               		ld		h,0
      63   00:4062  CD E1 42                    call    PrintNum
      64   00:4065                      
      65   00:4065                      
      66   00:4065  CD 49 45            		call	en_scc
      67   00:4068                      
      68   00:4068  F3                          di
      69   00:4069                      
      70   00:4069  3E 3F                       ld      a,3Fh
      71   00:406B  32 00 90                    ld      (sccBank3),a
      72   00:406E                      
      73   00:406E  CD 3B 43                    call    SccAdjust
      74   00:4071  CD 8B 43                    call    SccInit
      75   00:4074  CD C8 42                    call    ReplayerMute
      76   00:4077  CD 27 41                    call    InstallIntHanlder
      77   00:407A                      
      78   00:407A                      
      79   00:407A                       ; print period from SccAdjust
      80   00:407A                      
      81   00:407A  2A 04 D0                    ld      hl,(Period)
      82   00:407D  11 00 00                    ld      de,0
      83   00:4080  CD E1 42                    call    PrintNum
      84   00:4083                      
      85   00:4083  11 7D 00            		ld		de,3*40+5
      86   00:4086  21 EC 40            		ld		hl,instruction_text
      87   00:4089  CD DA 40            		call	message
      88   00:408C                      
      89   00:408C                      
      90   00:408C  FB                          ei
      91   00:408D                      
      92   00:408D                      .halt:
      93   00:408D                      
      94   00:408D                      ; print blocks to play
      95   00:408D  76                          halt
      96   00:408E                      
      97   00:408E  2A 06 D0                    ld      hl,(NumBlocksToPlay)
      98   00:4091  11 08 00                    ld      de,8
      99   00:4094  CD E1 42                    call    PrintNum
     100   00:4097                      
     101   00:4097  2A 00 D0                    ld      hl,(SamplePos)
     102   00:409A  11 10 00                    ld      de,16
     103   00:409D  CD E1 42                    call    PrintNum
     104   00:40A0                      
     105   00:40A0  2A 02 D0                    ld      hl,(SamplePage)
     106   00:40A3  26 00                       ld      h,0
     107   00:40A5  11 18 00                    ld      de,24
     108   00:40A8  CD E1 42                    call    PrintNum
     109   00:40AB                      
     110   00:40AB                      ; play one sfx at time
     111   00:40AB  3A 08 D0            		ld      a,(SccSfxOn)
     112   00:40AE  B7                          or      a
     113   00:40AF  CC B5 40            		call	z,effetct24
     114   00:40B2  C3 8D 40            		jp		.halt
     115   00:40B5                      
     116   00:40B5                      ; Keyboard testing
     117   00:40B5                      ; 2 "B" "A" ??? "/" "." "," "'" "`"
     118   00:40B5                      ; 3 "J" "I" "H" "G" "F" "E" "D" "C"
     119   00:40B5                      ; 4 "R" "Q" "P" "O" "N" "M" "L" "K"
     120   00:40B5                      ; 5 "Z" "Y" "X" "W" "V" "U" "T" "S"
     121   00:40B5                      ; 6 F3 F2  F1 CODE CAP GRAPH CTR SHIFT
     122   00:40B5                      ; 7 RET SEL BS STOP TAB ESC F5  F4
     123   00:40B5                      ; 8 RIGHT DOWN UP LEFT DEL INS HOME SPACE
     124   00:40B5                      
     125   00:40B5                      effetct24:
     126   00:40B5                      
     127   00:40B5  11 03 00            		ld      de,3
     128   00:40B8  D5                  2: 		push	de
     129   00:40B9  CD C9 43             		call    checkkbd
     130   00:40BC  06 08                		ld      b,8
     131   00:40BE  4F                   		ld      c,a
     132   00:40BF                      1:
     133   00:40BF  78                   		ld      a,b
     134   00:40C0  3D                   		dec     a
     135   00:40C1  82                  		add		a,d
     136   00:40C2  6F                   		ld      l,a
     137   00:40C3  79                   		ld      a,c
     138   00:40C4  87                   		add     a,a
     139   00:40C5  4F                   		ld      c,a
     140   00:40C6  C5                   		push    bc
     141   00:40C7  7D                   		ld      a,l
     142   00:40C8  D4 3E 41             		call    nc,ReplayerInit
     143   00:40CB  C1                   		pop     bc
     144   00:40CC  10 F1                		djnz    1B
     145   00:40CE  D1                  		pop		de
     146   00:40CF  3E 08               		ld		a,8
     147   00:40D1  82                  		add		a,d
     148   00:40D2  57                  		ld		d,a
     149   00:40D3  1C                  		inc		e
     150   00:40D4  3E 08               		ld		a,8
     151   00:40D6  BB                  		cp		e
     152   00:40D7  30 DF               		jr		nc,2B
     153   00:40D9                      
     154   00:40D9  C9                   		ret
     155   00:40DA                      ;-------------------------------------
     156   00:40DA                      ;-------------------------------------
     157   00:40DA                      message:
     158   00:40DA  7B                          ld      a,e
     159   00:40DB  D3 99                       out     (99h),a
     160   00:40DD  7A                          ld      a,d
     161   00:40DE  E6 3F                       and     3Fh
     162   00:40E0  F6 40                       or      40h
     163   00:40E2  D3 99                       out     (99h),a
     164   00:40E4                      
     165   00:40E4  7E                  1:		ld		a,(hl)
     166   00:40E5  A7                  		and		a
     167   00:40E6  C8                  		ret		z
     168   00:40E7  D3 98               		out     (98h),a
     169   00:40E9  23                  		inc		hl
     170   00:40EA  18 F8               		jr		1b
     171   00:40EC                      
     172   00:40EC                      instruction_text:
     173   00:40EC                      		db "Press any key from C to Z",0
     173   00:40EC  50 72 65 73 73 20 61 6E 79 20 6B 65 79 20 66 72 
     173   00:40FC  6F 6D 20 43 20 74 6F 20 5A 00 
     174   00:4106                      scc_slot_text:
     175   00:4106                      		db	"Scc slot: ",0
     175   00:4106  53 63 63 20 73 6C 6F 74 3A 20 00 
     176   00:4111                      rom_slot_text:
     177   00:4111                      		db	"Rom slot: ",0
     177   00:4111  52 6F 6D 20 73 6C 6F 74 3A 20 00 
     178   00:411C                      ram_slot_text:
     179   00:411C                      		db	"Ram slot: ",0
     179   00:411C  52 61 6D 20 73 6C 6F 74 3A 20 00 
     180   00:4127                      
     181   00:4127                      ;-------------------------------------
     182   00:4127                      ;-------------------------------------
     183   00:4127                      InstallIntHanlder:
     184   00:4127  F3                          di
     185   00:4128  3E C3                       ld      a,0xC3
     186   00:412A  21 34 41                    ld      hl,HandleInt
     187   00:412D  32 9A FD                    ld      ($FD9A),a
     188   00:4130  22 9B FD                    ld      ($FD9B),hl
     189   00:4133  C9                          ret
     190   00:4134                      
     191   00:4134                      ;-------------------------------------
     192   00:4134                      ;-------------------------------------
     193   00:4134                      HandleInt:
     194   00:4134  F5                          push    af
     195   00:4135                      
     196   00:4135  3A 08 D0                    ld      a,(SccSfxOn)
     197   00:4138  B7                          or      a
     198   00:4139  C4 A2 41                    call    nz,ReplayerUpdate
     199   00:413C                      
     200   00:413C  F1                          pop     af
     201   00:413D  C9                          ret
     202   00:413E                      
     203   00:413E                      
     204   00:413E                      
     205   00:413E                      ;-------------------------------------
     206   00:413E                      ; Initialize replayer
     207   00:413E                      ;
     208   00:413E                      ; in :
     209   00:413E                      ; l  # of Sfx
     210   00:413E                      ;
     211   00:413E                      ;-------------------------------------
     212   00:413E                      ReplayerInit:
     213   00:413E  26 00                       ld      h,0
     214   00:4140                      
     215   00:4140  54                          ld      d,h
     216   00:4141  5D                          ld      e,l
     217   00:4142                      
     218   00:4142  29                          add     hl,hl
     219   00:4143  29                          add     hl,hl
     220   00:4144  19                          add     hl,de
     221   00:4145                      
     222   00:4145  11 66 41                    ld      de,SfxTable
     223   00:4148  19                          add     hl,de
     224   00:4149                      
     225   00:4149  5E                          ld      e,(hl)
     226   00:414A  23                          inc     hl
     227   00:414B  56                          ld      d,(hl)
     228   00:414C  23                          inc     hl
     229   00:414D  ED 53 00 D0                 ld      (SamplePos),de
     230   00:4151                      
     231   00:4151  7E                          ld      a,(hl)
     232   00:4152  23                          inc     hl
     233   00:4153  32 02 D0                    ld      (SamplePage),a
     234   00:4156  32 00 68                    ld      (Bank2),a
     235   00:4159                      
     236   00:4159  5E                          ld      e,(hl)
     237   00:415A  23                          inc     hl
     238   00:415B  56                          ld      d,(hl)
     239   00:415C  ED 53 06 D0                 ld      (NumBlocksToPlay),de
     240   00:4160                      
     241   00:4160  3E FF                       ld      a,0FFh
     242   00:4162  32 08 D0                    ld      (SccSfxOn),a
     243   00:4165                      
     244   00:4165  C9                          ret
     245   00:4166                      
     246   00:4166                      SfxTable:
     247   00:4166                               include SfxTable.asm
       1.  00:4166  (00:000C)           nwavs:       equ  12
       2.  00:4166                      
       3.  00:4166  00 60                        dw     06000h + (s0_START & 01FFFH)
       4.  00:4168  01                           db     s0_START/02000h-2
       5.  00:4169  37 00                        dw     (s0_END - s0_START+95)/96
       6.  00:416B                          
       7.  00:416B  A0 74                        dw     06000h + (s1_START & 01FFFH)
       8.  00:416D  01                           db     s1_START/02000h-2
       9.  00:416E  64 01                        dw     (s1_END - s1_START+95)/96
      10.  00:4170                          
      11.  00:4170  20 7A                        dw     06000h + (s2_START & 01FFFH)
      12.  00:4172  05                           db     s2_START/02000h-2
      13.  00:4173  4C 01                        dw     (s2_END - s2_START+95)/96
      14.  00:4175                          
      15.  00:4175  A0 76                        dw     06000h + (s3_START & 01FFFH)
      16.  00:4177  09                           db     s3_START/02000h-2
      17.  00:4178  C8 00                        dw     (s3_END - s3_START+95)/96
      18.  00:417A                          
      19.  00:417A  A0 61                        dw     06000h + (s4_START & 01FFFH)
      20.  00:417C  0C                           db     s4_START/02000h-2
      21.  00:417D  B2 00                        dw     (s4_END - s4_START+95)/96
      22.  00:417F                          
      23.  00:417F  60 64                        dw     06000h + (s5_START & 01FFFH)
      24.  00:4181  0E                           db     s5_START/02000h-2
      25.  00:4182  C8 00                        dw     (s5_END - s5_START+95)/96
      26.  00:4184                          
      27.  00:4184  60 6F                        dw     06000h + (s6_START & 01FFFH)
      28.  00:4186  10                           db     s6_START/02000h-2
      29.  00:4187  C8 00                        dw     (s6_END - s6_START+95)/96
      30.  00:4189                          
      31.  00:4189  60 7A                        dw     06000h + (s7_START & 01FFFH)
      32.  00:418B  12                           db     s7_START/02000h-2
      33.  00:418C  B2 00                        dw     (s7_END - s7_START+95)/96
      34.  00:418E                          
      35.  00:418E  20 7D                        dw     06000h + (s8_START & 01FFFH)
      36.  00:4190  14                           db     s8_START/02000h-2
      37.  00:4191  4E 01                        dw     (s8_END - s8_START+95)/96
      38.  00:4193                          
      39.  00:4193  60 7A                        dw     06000h + (s9_START & 01FFFH)
      40.  00:4195  18                           db     s9_START/02000h-2
      41.  00:4196  FB 00                        dw     (s9_END - s9_START+95)/96
      42.  00:4198                          
      43.  00:4198  80 78                        dw     06000h + (s10_START & 01FFFH)
      44.  00:419A  1B                           db     s10_START/02000h-2
      45.  00:419B  60 00                        dw     (s10_END - s10_START+95)/96
      46.  00:419D                          
      47.  00:419D  80 7C                        dw     06000h + (s11_START & 01FFFH)
      48.  00:419F  1C                           db     s11_START/02000h-2
      49.  00:41A0  C8 00                        dw     (s11_END - s11_START+95)/96
      50.  00:41A2                          
     248   00:41A2                      
     249   00:41A2                      
     250   00:41A2                      ;-------------------------------------
     251   00:41A2                      ; write 32 samples and moves sample pointer to next page
     252   00:41A2                      ;-------------------------------------
     253   00:41A2                      		macro	my_ldir
     254   00:41A2                    <         repeat  32
     255   00:41A2                    <         ldi						; 18*32
     256   00:41A2                    <         endrepeat
     257   00:41A2                    <         bit     7,h				; 10
     258   00:41A2                    <         jp 		z,1f			; 11
     259   00:41A2                    <         ld      a,(SamplePage)
     260   00:41A2                    <         inc     a
     261   00:41A2                    <         ld      (SamplePage),a
     262   00:41A2                    <         ld      (Bank2),a
     263   00:41A2                    <         ld		h,060h
     264   00:41A2                    <         ld      a,(Period)
     265   00:41A2                    < 1:		nop						; 10 dummy
     266   00:41A2                    < 		nop						; 1 cycle is missing
     267   00:41A2                    < 		endm
     268   00:41A2                      		
     269   00:41A2                      		
     270   00:41A2                      ReplayerUpdate:
     271   00:41A2  2A 00 D0                    ld      hl,(SamplePos)
     272   00:41A5  3A 04 D0                    ld      a,(Period)
     273   00:41A8  11 00 98                    ld      de,9800h
     274   00:41AB                      
     275   00:41AB                              ;622 cycles except at bank swap
     276   00:41AB                      
     277   00:41AB                              ; phase 0
     278   00:41AB                              my_ldir
     278   00:41AB                    >         repeat  32
     278   00:41AB                    <         ldi
     278   00:41AB                    <         endrepeat
     278   00:41AB  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     278   00:41BB  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     278   00:41CB  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     278   00:41DB  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     278   00:41EB  CB 7C             >         bit     7,h
     278   00:41ED  CA FF 41          >         jp   z,1f
     278   00:41F0  3A 02 D0          >         ld      a,(SamplePage)
     278   00:41F3  3C                >         inc     a
     278   00:41F4  32 02 D0          >         ld      (SamplePage),a
     278   00:41F7  32 00 68          >         ld      (Bank2),a
     278   00:41FA  26 60             >         ld  h,060h
     278   00:41FC  3A 04 D0          >         ld      a,(Period)
     278   00:41FF  00                > 1:  nop
     278   00:4200  00                >   nop
     279   00:4201  32 80 98                    ld      (9880h),a       ; 14
     280   00:4204                      		
     281   00:4204                              ; phase 1
     282   00:4204                              my_ldir
     282   00:4204                    >         repeat  32
     282   00:4204                    <         ldi
     282   00:4204                    <         endrepeat
     282   00:4204  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     282   00:4214  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     282   00:4224  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     282   00:4234  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     282   00:4244  CB 7C             >         bit     7,h
     282   00:4246  CA 58 42          >         jp   z,1f
     282   00:4249  3A 02 D0          >         ld      a,(SamplePage)
     282   00:424C  3C                >         inc     a
     282   00:424D  32 02 D0          >         ld      (SamplePage),a
     282   00:4250  32 00 68          >         ld      (Bank2),a
     282   00:4253  26 60             >         ld  h,060h
     282   00:4255  3A 04 D0          >         ld      a,(Period)
     282   00:4258  00                > 1:  nop
     282   00:4259  00                >   nop
     283   00:425A  32 82 98                    ld      (9882h),a		; 14
     284   00:425D                      		
     285   00:425D                              ; phase 2
     286   00:425D                              my_ldir
     286   00:425D                    >         repeat  32
     286   00:425D                    <         ldi
     286   00:425D                    <         endrepeat
     286   00:425D  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     286   00:426D  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     286   00:427D  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     286   00:428D  ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 ED A0 
     286   00:429D  CB 7C             >         bit     7,h
     286   00:429F  CA B1 42          >         jp   z,1f
     286   00:42A2  3A 02 D0          >         ld      a,(SamplePage)
     286   00:42A5  3C                >         inc     a
     286   00:42A6  32 02 D0          >         ld      (SamplePage),a
     286   00:42A9  32 00 68          >         ld      (Bank2),a
     286   00:42AC  26 60             >         ld  h,060h
     286   00:42AE  3A 04 D0          >         ld      a,(Period)
     286   00:42B1  00                > 1:  nop
     286   00:42B2  00                >   nop
     287   00:42B3  32 84 98                    ld      (9884h),a		; 14
     288   00:42B6                      
     289   00:42B6  22 00 D0                    ld      (SamplePos),hl
     290   00:42B9                      
     291   00:42B9  3E 07               		ld      a,00000111b     ; channels 1-3 active
     292   00:42BB  32 8F 98                    ld      (988Fh),a
     293   00:42BE  2A 06 D0                    ld      hl,(NumBlocksToPlay)
     294   00:42C1  2B                          dec     hl                       ; does NOT affect Z flag
     295   00:42C2  22 06 D0                    ld      (NumBlocksToPlay),hl
     296   00:42C5                      
     297   00:42C5  7C                          ld      a,h
     298   00:42C6  B5                          or      l
     299   00:42C7  C0                  		ret		nz
     300   00:42C8                      
     301   00:42C8                      ;-------------------------------------
     302   00:42C8                      ; Mute replayer
     303   00:42C8                      ;-------------------------------------
     304   00:42C8                      ReplayerMute:
     305   00:42C8                      
     306   00:42C8  AF                          xor      a
     307   00:42C9  32 08 D0                    ld      (SccSfxOn),a
     308   00:42CC  32 8F 98                    ld      (988Fh),a	; all channels inactive
     309   00:42CF  C9                          ret
     310   00:42D0                      
     311   00:42D0                      
     312   00:42D0                      ;-------------------------------------
     313   00:42D0                      ; To make rom guesseres happy
     314   00:42D0                      ;-------------------------------------
     315   00:42D0                      init_mapper:
     316   00:42D0  AF                          xor     a
     317   00:42D1  32 00 60                    ld      (Bank1),a
     318   00:42D4  3C                  		inc		a
     319   00:42D5  32 00 68                    ld      (Bank2),a
     320   00:42D8  3C                  		inc		a
     321   00:42D9  32 00 70                    ld      (Bank3),a
     322   00:42DC  3C                  		inc		a
     323   00:42DD  32 00 78                    ld      (Bank4),a
     324   00:42E0  C9                          ret
     325   00:42E1                      
     326   00:42E1                      ;-------------------------------------
     327   00:42E1                      ; method that prints hl on screen
     328   00:42E1                      ; to address de
     329   00:42E1                      ;-------------------------------------
     330   00:42E1                      PrintNum:
     331   00:42E1  7B                          ld      a,e
     332   00:42E2  D3 99                       out     (99h),a
     333   00:42E4  7A                          ld      a,d
     334   00:42E5  E6 3F                       and     3Fh
     335   00:42E7  F6 40                       or      40h
     336   00:42E9  D3 99                       out     (99h),a
     337   00:42EB                      
     338   00:42EB  E5                          push    hl
     339   00:42EC  EB                          ex      de,hl
     340   00:42ED                      
     341   00:42ED  7A                          ld      a,d
     342   00:42EE  07                          rlca
     343   00:42EF  07                          rlca
     344   00:42F0  07                          rlca
     345   00:42F1  07                          rlca
     346   00:42F2  E6 0F                       and     15
     347   00:42F4  06 00                       ld      b,0
     348   00:42F6  4F                          ld      c,a
     349   00:42F7  21 2B 43                    ld      hl,Numbers
     350   00:42FA  09                          add     hl,bc
     351   00:42FB  7E                          ld      a,(hl)
     352   00:42FC  D3 98                       out     (98h),a
     353   00:42FE                      
     354   00:42FE  7A                          ld      a,d
     355   00:42FF  E6 0F                       and     15
     356   00:4301  06 00                       ld      b,0
     357   00:4303  4F                          ld      c,a
     358   00:4304  21 2B 43                    ld      hl,Numbers
     359   00:4307  09                          add     hl,bc
     360   00:4308  7E                          ld      a,(hl)
     361   00:4309  D3 98                       out     (98h),a
     362   00:430B                      
     363   00:430B  7B                          ld      a,e
     364   00:430C  07                          rlca
     365   00:430D  07                          rlca
     366   00:430E  07                          rlca
     367   00:430F  07                          rlca
     368   00:4310  E6 0F                       and     15
     369   00:4312  06 00                       ld      b,0
     370   00:4314  4F                          ld      c,a
     371   00:4315  21 2B 43                    ld      hl,Numbers
     372   00:4318  09                          add     hl,bc
     373   00:4319  7E                          ld      a,(hl)
     374   00:431A  D3 98                       out     (98h),a
     375   00:431C                      
     376   00:431C  7B                          ld      a,e
     377   00:431D  E6 0F                       and     15
     378   00:431F  06 00                       ld      b,0
     379   00:4321  4F                          ld      c,a
     380   00:4322  21 2B 43                    ld      hl,Numbers
     381   00:4325  09                          add     hl,bc
     382   00:4326  7E                          ld      a,(hl)
     383   00:4327  D3 98                       out     (98h),a
     384   00:4329                      
     385   00:4329  E1                          pop     hl
     386   00:432A  C9                          ret
     387   00:432B                      
     388   00:432B                      Numbers:
     389   00:432B                              db  "0123456789ABCDEF"
     389   00:432B  30 31 32 33 34 35 36 37 38 39 41 42 43 44 45 46 
     390   00:433B                      
     391   00:433B                      ;-------------------------------------
     392   00:433B                      ; Adjusts the SCC period to the frame
     393   00:433B                      ; rate
     394   00:433B                      ;-------------------------------------
     395   00:433B                      
     396   00:433B  (00:08BC)           Period50: equ       (3579545/32/50-1)
     397   00:433B  (00:0749)           Period60: equ       (3579545/32*1001/(60*1000)-1)
     398   00:433B                      
     399   00:433B                      ;Period60: equ      749h
     400   00:433B                      
     401   00:433B                      SccAdjust:
     402   00:433B  21 49 07            		ld      hl,Period60
     403   00:433E  22 04 D0            		ld      (Period),hl
     404   00:4341                      
     405   00:4341  1E 07                       ld      e,7					;    7   |   RET   SEL   BS   STOP   TAB   ESC   F5    F4
     406   00:4343  CD C9 43                    call    checkkbd
     407   00:4346  FE FB                       cp      11111011b           ; key ESC
     408   00:4348  C0                          ret     nz
     409   00:4349                      
     410   00:4349                              ; press ESC at boot to start the frequency test
     411   00:4349                      		; WARNING it hangs on SCC+
     412   00:4349                      
     413   00:4349  3E 18                       ld      a,00011000b
     414   00:434B  32 8F 98                    ld      (988Fh),a		; activate ch 4 & 5 for testing
     415   00:434E                      
     416   00:434E  21 60 98                    ld      hl,9800h+32*3   ; counter in channel 4
     417   00:4351  01 00 20                    ld      bc,2000h
     418   00:4354                      .counter:
     419   00:4354  71                          ld      (hl),c
     420   00:4355  23                          inc     hl
     421   00:4356  0C                          inc     c
     422   00:4357  10 FB                       djnz    .counter
     423   00:4359                      
     424   00:4359  3E A0                       ld      a,10100000b     	; rotate channel 4&5 with ch4 freq., reset wav if freq is written
     425   00:435B  32 E0 98                    ld      (98E0h),a			; on SCC
     426   00:435E  32 C0 98                    ld  	(98C0h),a			; cover SCC+ in SCC mode
     427   00:4361                      
     428   00:4361  21 45 07                    ld      hl,Period60-4
     429   00:4364  DB 99                       in      a,(99h)
     430   00:4366  C3 81 43            		jp		2f					; expect in C any value > 31
     431   00:4369                      
     432   00:4369                      .loop:
     433   00:4369                      
     434   00:4369  DB 99               1:      in      a,(99h)
     435   00:436B  E6 80                       and     80h
     436   00:436D  CA 69 43                    jp      z,1B         ; wait vblank
     437   00:4370                      
     438   00:4370  3A 60 98                    ld      a,(9800h+32*3)
     439   00:4373  B9                          cp      c
     440   00:4374  CA 87 43                    jp      z,.end
     441   00:4377                      
     442   00:4377  0E 1F                       ld      c,31
     443   00:4379  23                          inc     hl
     444   00:437A                      
     445   00:437A  DB 99               1:      in      a,(99h)
     446   00:437C  E6 80                       and     80h
     447   00:437E  CA 7A 43                    jp      z,1B         ; wait vblank
     448   00:4381                      2:
     449   00:4381  22 86 98                    ld      (9886h),hl
     450   00:4384                      ;        ld      (9888h),hl	; ch5 not needed
     451   00:4384  C3 69 43                    jp      .loop
     452   00:4387                      .end:
     453   00:4387  22 04 D0                    ld      (Period),hl
     454   00:438A                      
     455   00:438A  C9                          ret
     456   00:438B                      
     457   00:438B                      ;-------------------------------------
     458   00:438B                      ; Initialize the scc
     459   00:438B                      ;-------------------------------------
     460   00:438B                      SccInit:
     461   00:438B  CD BB 43                    call SccMute
     462   00:438E                      
     463   00:438E  3E 20                       ld  	a,00100000b         ; Reset phase when freq is written
     464   00:4390  32 E0 98                    ld  	(98E0h),a			; on SCC
     465   00:4393  32 C0 98                    ld  	(98C0h),a			; cover SCC+ in SCC mode
     466   00:4396                      
     467   00:4396  3E 0F                       ld      a,15
     468   00:4398  32 8A 98                    ld      (988Ah),a       ; volume ch1
     469   00:439B  32 8B 98                    ld      (988Bh),a       ; volume ch2
     470   00:439E  32 8C 98                    ld      (988Ch),a       ; volume ch3
     471   00:43A1  AF                  		xor		a
     472   00:43A2  32 8D 98                    ld      (988Dh),a       ; volume ch4
     473   00:43A5  32 8E 98                    ld      (988Eh),a       ; experiment on ch4&5
     474   00:43A8                      
     475   00:43A8  2A 04 D0                    ld      hl,(Period)
     476   00:43AB  22 80 98                    ld      (9880h),hl
     477   00:43AE  22 82 98                    ld      (9882h),hl
     478   00:43B1  22 84 98                    ld      (9884h),hl
     479   00:43B4  22 86 98                    ld      (9886h),hl			; experiment on ch 4&5
     480   00:43B7  22 88 98                    ld      (9888h),hl
     481   00:43BA                      
     482   00:43BA  C9                          ret
     483   00:43BB                      
     484   00:43BB                      SccMute:
     485   00:43BB  21 00 98                    ld      hl,9800h
     486   00:43BE  11 01 98                    ld      de,9801h
     487   00:43C1  01 7F 00                    ld      bc,32*4 -1
     488   00:43C4                      
     489   00:43C4  36 00                       ld      (hl),0
     490   00:43C6  ED B0                       ldir
     491   00:43C8  C9                          ret
     492   00:43C9                      
     493   00:43C9                      ;-------------------------------------
     494   00:43C9                      ; checkkbd: ckeck keyboard line
     495   00:43C9                      ; syntax:checkkbd <keyboar line #>
     496   00:43C9                      ; in:  e
     497   00:43C9                      ; out: l
     498   00:43C9                      ;-------------------------------------
     499   00:43C9                      ; i8255 ports
     500   00:43C9                      ;
     501   00:43C9  (00:00A8)           i8255porta  equ 0a8h        ; slot selection
     502   00:43C9  (00:00A9)           i8255portb  equ 0a9h        ; keyboard column input
     503   00:43C9  (00:00AA)           i8255portc  equ 0aah        ; leds, motor, cassette, kbd line
     504   00:43C9  (00:00AB)           i8255portd  equ 0abh        ; mode select for i8255 ports A,B,C
     505   00:43C9                      
     506   00:43C9                      checkkbd:
     507   00:43C9  DB AA                       in  a,(i8255portc)
     508   00:43CB  E6 F0                       and 011110000B          ; upper 4 bits contain info to preserve
     509   00:43CD  B3                          or  e
     510   00:43CE  D3 AA                       out (i8255portc),a
     511   00:43D0  DB A9                       in  a,(i8255portb)
     512   00:43D2  6F                          ld  l,a
     513   00:43D3  C9                          ret
     514   00:43D4                      
     515   00:43D4                      ; #define right (!(kbd & 128))
     516   00:43D4                      ; #define left 	(!(kbd & 16))
     517   00:43D4                      ; #define up 	(!(kbd & 32))
     518   00:43D4                      ; #define down 	(!(kbd & 64))
     519   00:43D4                      ; // space
     520   00:43D4                      ; #define key1 	(!(kbd & 1))
     521   00:43D4                      ; // M
     522   00:43D4                      ; #define key2 	(!(kb2 & 4))
     523   00:43D4                      
     524   00:43D4                      ;  Bit_7 Bit_6 Bit_5 Bit_4 Bit_3 Bit_2 Bit_1 Bit_0
     525   00:43D4                      ; 0 "7" "6" "5" "4" "3" "2" "1" "0"
     526   00:43D4                      ; 1 ";" "]" "[" "\" "=" "-" "9" "8"
     527   00:43D4                      ; 2 "B" "A" ??? "/" "." "," "'" "`"
     528   00:43D4                      ; 3 "J" "I" "H" "G" "F" "E" "D" "C"
     529   00:43D4                      ; 4 "R" "Q" "P" "O" "N" "M" "L" "K"
     530   00:43D4                      ; 5 "Z" "Y" "X" "W" "V" "U" "T" "S"
     531   00:43D4                      ; 6 F3 F2  F1 CODE CAP GRAPH CTR SHIFT
     532   00:43D4                      ; 7 RET SEL BS STOP TAB ESC F5  F4
     533   00:43D4                      ; 8 RIGHT DOWN UP LEFT DEL INS HOME SPACE
     534   00:43D4                      
     535   00:43D4                      
     536   00:43D4                      ;-------------------------------------
     537   00:43D4                      ; SCC and Slot management
     538   00:43D4                      ;-------------------------------------
     539   00:43D4                               include rominit64.asm
       1.  00:43D4                      
       2.  00:43D4                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
       3.  00:43D4                      ; set pages and subslot
       4.  00:43D4                      ;
       5.  00:43D4                      
       6.  00:43D4                      
       7.  00:43D4  (00:0024)           ENASLT:			equ		024h
       8.  00:43D4  (00:0138)           RSLREG:			equ		0138h
       9.  00:43D4  (00:013B)           WSLREG:			equ		013Bh
      10.  00:43D4  (00:FCC1)           EXPTBL:			equ		0FCC1h	; Bios Slot / Expansion Slot
      11.  00:43D4                      
      12.  00:43D4                      
      13.  00:43D4                      ; ----------------------------
      14.  00:43D4                      ; pre-set main slot for page 3
      15.  00:43D4                      ; and set sub-slot for page 3
      16.  00:43D4                      ; ----------------------------
      17.  00:43D4                      	macro	mainslot_setup n
      18.  00:43D4                    < 	and		3
      19.  00:43D4                    < [2]	rrca
      20.  00:43D4                    < 	and		0xC0
      21.  00:43D4                    < 	ld		c,a
      22.  00:43D4                    < 	ld		a,d
      23.  00:43D4                    < 	and		0x3F
      24.  00:43D4                    < 	or		c
      25.  00:43D4                    < 	ld		c,a					; Primary slot value with main slot in page 3
      26.  00:43D4                    < 
      27.  00:43D4                    < 	ld		a,b
      28.  00:43D4                    < 	and		0x0C
      29.  00:43D4                    < [2]	rrca
      30.  00:43D4                    < 	and		3
      31.  00:43D4                    < 	ld		b,a					; B = Expanded slot in page 3
      32.  00:43D4                    < 	ld		a,c
      33.  00:43D4                    < 	out		(0A8h),a			; Slot : Main Slot, xx, xx, Main slot
      34.  00:43D4                    < 	ld		a,(0FFFFh)
      35.  00:43D4                    < 	cpl
      36.  00:43D4                    < 	if (n<=4)
      37.  00:43D4                    < [n]	RLCA
      38.  00:43D4                    < 	else
      39.  00:43D4                    < [8-n] RRCA	
      40.  00:43D4                    < 	endif
      41.  00:43D4                    < 	and		0xFC
      42.  00:43D4                    < 	or		b
      43.  00:43D4                    < 	if (n<=4)
      44.  00:43D4                    < [n]	RRCA
      45.  00:43D4                    < 	else
      46.  00:43D4                    < [8-n] RLCA
      47.  00:43D4                    < 	endif
      48.  00:43D4                    < 	ld		(0FFFFh),a		; Expanded slot selected
      49.  00:43D4                    < 	ld		b,a				; save for later	
      50.  00:43D4                    < 	endmacro
      51.  00:43D4                      		
      52.  00:43D4                      
      53.  00:43D4                      ; ------------------------------
      54.  00:43D4                      ; SEARCH_SLOT
      55.  00:43D4                      ; look for the slot of our rom
      56.  00:43D4                      ; active in page 1
      57.  00:43D4                      ; ------------------------------
      58.  00:43D4                      
      59.  00:43D4                      search_slot:
      60.  00:43D4  CD 38 01            	call	RSLREG
      61.  00:43D7  0F 0F               [2]	rrca
      62.  00:43D9  E6 03               	and		3
      63.  00:43DB  4F                  	ld		c,a
      64.  00:43DC  06 00               	ld		b,0
      65.  00:43DE  21 C1 FC            	ld		hl,EXPTBL
      66.  00:43E1  09                  	add		hl,bc
      67.  00:43E2  7E                  	ld		a,(hl)
      68.  00:43E3  E6 80               	and		080h
      69.  00:43E5  B1                  	or		c
      70.  00:43E6  4F                  	ld		c,a
      71.  00:43E7  23 23 23 23         [4]	inc		hl
      72.  00:43EB  7E                  	ld		a,(hl)
      73.  00:43EC  E6 0C               	and		0Ch
      74.  00:43EE  B1                  	or		c
      75.  00:43EF  32 0C D0            	ld		(slotvar),a
      76.  00:43F2  C9                  	ret
      77.  00:43F3                      	
      78.  00:43F3                      ; ------------------------------
      79.  00:43F3                      ; look for the slot of ram
      80.  00:43F3                      ; active in page 3
      81.  00:43F3                      ; ------------------------------
      82.  00:43F3                      
      83.  00:43F3                      search_slotram:
      84.  00:43F3  F3                  	di
      85.  00:43F4  CD 38 01            	call	RSLREG
      86.  00:43F7  07 07               [2]	rlca
      87.  00:43F9  E6 03               	and		3
      88.  00:43FB  4F                  	ld		c,a
      89.  00:43FC  06 00               	ld		b,0
      90.  00:43FE  21 C1 FC            	ld		hl,EXPTBL
      91.  00:4401  09                  	add		hl,bc
      92.  00:4402  7E                  	ld		a,(hl)
      93.  00:4403  E6 80               	and		080h
      94.  00:4405  28 0D               	jr		z,search_slotram0
      95.  00:4407  B1                  	or		c
      96.  00:4408  4F                  	ld		c,a
      97.  00:4409  23 23 23 23         [4]	inc		hl
      98.  00:440D  7E                  	ld		a,(hl)
      99.  00:440E  07 07 07 07         [4]	rlca
     100.  00:4412  E6 0C               	and		0Ch
     101.  00:4414                      search_slotram0:
     102.  00:4414  B1                  	or		c
     103.  00:4415  32 0E D0            	ld		(slotram),a
     104.  00:4418  C9                  	ret
     105.  00:4419                      	
     106.  00:4419                      ; ------------------------------
     107.  00:4419                      ; SETROMPAGE0
     108.  00:4419                      ; Set the chart in
     109.  00:4419                      ; Page 0
     110.  00:4419                      ; -----------------------------
     111.  00:4419                      
     112.  00:4419                      setrompage0:
     113.  00:4419  3A 0C D0            	ld		a,(slotvar)
     114.  00:441C  C3 3A 44            	jp		setslotpage0
     115.  00:441F                      
     116.  00:441F                      setrompage2:
     117.  00:441F  3A 0C D0            	ld		a,(slotvar)
     118.  00:4422  C3 B0 44            	jp		setslotpage2
     119.  00:4425                      
     120.  00:4425                      setrampage2:
     121.  00:4425  3A 0E D0            	ld		a,(slotram)
     122.  00:4428  C3 B0 44            	jp		setslotpage2
     123.  00:442B                      	
     124.  00:442B                      setrompage3:
     125.  00:442B  3A 0C D0            	ld		a,(slotvar)
     126.  00:442E  C3 F7 44            	jp		setslotpage3
     127.  00:4431                      
     128.  00:4431                      setrampage3:
     129.  00:4431  3A 0E D0            	ld		a,(slotram)
     130.  00:4434  C3 F7 44            	jp		setslotpage3
     131.  00:4437                      	
     132.  00:4437                      ; ------------------------------
     133.  00:4437                      ; RECBIOS
     134.  00:4437                      ; set the bios ROM
     135.  00:4437                      ; -------------------------------
     136.  00:4437                      recbios:
     137.  00:4437  3A C1 FC            	ld		a,(EXPTBL)
     138.  00:443A                      
     139.  00:443A                      ; ---------------------------
     140.  00:443A                      ; SETSLOTPAGE0
     141.  00:443A                      ; Set the slot passed in A
     142.  00:443A                      ; at page 0 in the Z80 address space
     143.  00:443A                      ; A: Format FxxxSSPP
     144.  00:443A                      ; ----------------------------
     145.  00:443A                      
     146.  00:443A                      setslotpage0:
     147.  00:443A  F3                  	di
     148.  00:443B  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     149.  00:443C  DB A8               	in		a,(0A8h)
     150.  00:443E  E6 FC               	and		0xFC
     151.  00:4440  57                  	ld		d,a					; D = Primary slot value
     152.  00:4441  78                  	ld		a,b
     153.  00:4442  E6 03               	and		3
     154.  00:4444  B2                  	or		d
     155.  00:4445  57                  	ld		d,a		; D = Final Value for primary slot
     156.  00:4446  78                  	ld		a,b		; Check if expanded
     157.  00:4447  CB 7F               	bit		7,a
     158.  00:4449  28 22               	jr		z,1f	; Not Expanded
     159.  00:444B                      	mainslot_setup	0
     159.  00:444B  E6 03             >  and  3
     159.  00:444D  0F 0F             > [2] rrca
     159.  00:444F  E6 C0             >  and  0xC0
     159.  00:4451  4F                >  ld  c,a
     159.  00:4452  7A                >  ld  a,d
     159.  00:4453  E6 3F             >  and  0x3F
     159.  00:4455  B1                >  or  c
     159.  00:4456  4F                >  ld  c,a
     159.  00:4457                    > 
     159.  00:4457  78                >  ld  a,b
     159.  00:4458  E6 0C             >  and  0x0C
     159.  00:445A  0F 0F             > [2] rrca
     159.  00:445C  E6 03             >  and  3
     159.  00:445E  47                >  ld  b,a
     159.  00:445F  79                >  ld  a,c
     159.  00:4460  D3 A8             >  out  (0A8h),a
     159.  00:4462  3A FF FF          >  ld  a,(0FFFFh)
     159.  00:4465  2F                >  cpl
     159.  00:4466                    >  if (n<=4)
     159.  00:4466                    > [n] RLCA
     159.  00:4466                    >  else
     159.  00:4466                    ~ [8-n] RRCA
     159.  00:4466                    ~  endif
     159.  00:4466  E6 FC             >  and  0xFC
     159.  00:4468  B0                >  or  b
     159.  00:4469                    >  if (n<=4)
     159.  00:4469                    > [n] RRCA
     159.  00:4469                    >  else
     159.  00:4469                    ~ [8-n] RLCA
     159.  00:4469                    ~  endif
     159.  00:4469  32 FF FF          >  ld  (0FFFFh),a
     159.  00:446C  47                >  ld  b,a
     160.  00:446D  7A                  1:	ld		a,d				; A = Final value
     161.  00:446E  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     162.  00:4470  C9                  	ret
     163.  00:4471                      
     164.  00:4471                      ; ---------------------------
     165.  00:4471                      ; SETSLOTPAGE1
     166.  00:4471                      ; Set the slot passed in A
     167.  00:4471                      ; at page 1 in the Z80 address space
     168.  00:4471                      ; A: Format FxxxSSPP
     169.  00:4471                      ; ----------------------------
     170.  00:4471                      
     171.  00:4471                      setslotpage1:
     172.  00:4471  F3                  	di
     173.  00:4472  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     174.  00:4473  DB A8               	in		a,(0A8h)
     175.  00:4475  0F 0F               [2]	RRCA
     176.  00:4477  E6 FC               	and		0xFC
     177.  00:4479  57                  	ld		d,a					; D = Primary slot value
     178.  00:447A  78                  	ld		a,b
     179.  00:447B  E6 03               	and		3
     180.  00:447D  B2                  	or		d
     181.  00:447E  07 07               [2]	RLCA
     182.  00:4480  57                  	ld		d,a		; D = Final Value for primary slot
     183.  00:4481  78                  	ld		a,b		; Check if expanded
     184.  00:4482  CB 7F               	bit		7,a
     185.  00:4484  28 26               	jr		z,1f	; Not Expanded
     186.  00:4486                      	mainslot_setup	6
     186.  00:4486  E6 03             >  and  3
     186.  00:4488  0F 0F             > [2] rrca
     186.  00:448A  E6 C0             >  and  0xC0
     186.  00:448C  4F                >  ld  c,a
     186.  00:448D  7A                >  ld  a,d
     186.  00:448E  E6 3F             >  and  0x3F
     186.  00:4490  B1                >  or  c
     186.  00:4491  4F                >  ld  c,a
     186.  00:4492                    > 
     186.  00:4492  78                >  ld  a,b
     186.  00:4493  E6 0C             >  and  0x0C
     186.  00:4495  0F 0F             > [2] rrca
     186.  00:4497  E6 03             >  and  3
     186.  00:4499  47                >  ld  b,a
     186.  00:449A  79                >  ld  a,c
     186.  00:449B  D3 A8             >  out  (0A8h),a
     186.  00:449D  3A FF FF          >  ld  a,(0FFFFh)
     186.  00:44A0  2F                >  cpl
     186.  00:44A1                    >  if (n<=4)
     186.  00:44A1                    ~ [n] RLCA
     186.  00:44A1                    ~  else
     186.  00:44A1  0F 0F             > [8-n] RRCA
     186.  00:44A3                    >  endif
     186.  00:44A3  E6 FC             >  and  0xFC
     186.  00:44A5  B0                >  or  b
     186.  00:44A6                    >  if (n<=4)
     186.  00:44A6                    ~ [n] RRCA
     186.  00:44A6                    ~  else
     186.  00:44A6  07 07             > [8-n] RLCA
     186.  00:44A8                    >  endif
     186.  00:44A8  32 FF FF          >  ld  (0FFFFh),a
     186.  00:44AB  47                >  ld  b,a
     187.  00:44AC  7A                  1:	ld		a,d				; A = Final value
     188.  00:44AD  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     189.  00:44AF  C9                  	ret
     190.  00:44B0                      	
     191.  00:44B0                      
     192.  00:44B0                      ; ---------------------------
     193.  00:44B0                      ; SETSLOTPAGE2
     194.  00:44B0                      ; Set the slot passed in A
     195.  00:44B0                      ; at page 2 in the Z80 address space
     196.  00:44B0                      ; A: Format FxxxSSPP
     197.  00:44B0                      ; ----------------------------
     198.  00:44B0                      
     199.  00:44B0                      setslotpage2:
     200.  00:44B0  F3                  	di
     201.  00:44B1  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     202.  00:44B2  DB A8               	in		a,(0A8h)
     203.  00:44B4  07 07 07 07         [4]	RLCA
     204.  00:44B8  E6 FC               	and		0xFC
     205.  00:44BA  57                  	ld		d,a					; D = Primary slot value
     206.  00:44BB  78                  	ld		a,b
     207.  00:44BC  E6 03               	and		3
     208.  00:44BE  B2                  	or		d
     209.  00:44BF  0F 0F 0F 0F         [4]	RRCA
     210.  00:44C3  57                  	ld		d,a		; D = Final Value for primary slot
     211.  00:44C4  78                  	ld		a,b		; Check if expanded
     212.  00:44C5  CB 7F               	bit		7,a
     213.  00:44C7  28 2A               	jr		z,1f	; Not Expanded
     214.  00:44C9                      	mainslot_setup	4
     214.  00:44C9  E6 03             >  and  3
     214.  00:44CB  0F 0F             > [2] rrca
     214.  00:44CD  E6 C0             >  and  0xC0
     214.  00:44CF  4F                >  ld  c,a
     214.  00:44D0  7A                >  ld  a,d
     214.  00:44D1  E6 3F             >  and  0x3F
     214.  00:44D3  B1                >  or  c
     214.  00:44D4  4F                >  ld  c,a
     214.  00:44D5                    > 
     214.  00:44D5  78                >  ld  a,b
     214.  00:44D6  E6 0C             >  and  0x0C
     214.  00:44D8  0F 0F             > [2] rrca
     214.  00:44DA  E6 03             >  and  3
     214.  00:44DC  47                >  ld  b,a
     214.  00:44DD  79                >  ld  a,c
     214.  00:44DE  D3 A8             >  out  (0A8h),a
     214.  00:44E0  3A FF FF          >  ld  a,(0FFFFh)
     214.  00:44E3  2F                >  cpl
     214.  00:44E4                    >  if (n<=4)
     214.  00:44E4  07 07 07 07       > [n] RLCA
     214.  00:44E8                    >  else
     214.  00:44E8                    ~ [8-n] RRCA
     214.  00:44E8                    ~  endif
     214.  00:44E8  E6 FC             >  and  0xFC
     214.  00:44EA  B0                >  or  b
     214.  00:44EB                    >  if (n<=4)
     214.  00:44EB  0F 0F 0F 0F       > [n] RRCA
     214.  00:44EF                    >  else
     214.  00:44EF                    ~ [8-n] RLCA
     214.  00:44EF                    ~  endif
     214.  00:44EF  32 FF FF          >  ld  (0FFFFh),a
     214.  00:44F2  47                >  ld  b,a
     215.  00:44F3  7A                  1:	ld		a,d				; A = Final value
     216.  00:44F4  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     217.  00:44F6  C9                  	ret
     218.  00:44F7                      	
     219.  00:44F7                      ; ---------------------------
     220.  00:44F7                      ; SETSLOTPAGE3
     221.  00:44F7                      ; Set the slot passed in A
     222.  00:44F7                      ; at page 3 in the Z80 address space
     223.  00:44F7                      ; A: Format FxxxSSPP
     224.  00:44F7                      ; ----------------------------
     225.  00:44F7                      	
     226.  00:44F7                      setslotpage3:
     227.  00:44F7  F3                  	di
     228.  00:44F8  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     229.  00:44F9  DB A8               	in		a,(0A8h)
     230.  00:44FB  07 07               [2]	RLCA
     231.  00:44FD  E6 FC               	and		0xFC
     232.  00:44FF  57                  	ld		d,a					; D = Primary slot value
     233.  00:4500  78                  	ld		a,b
     234.  00:4501  E6 03               	and		3
     235.  00:4503  B2                  	or		d
     236.  00:4504  0F 0F               [2]	RRCA	
     237.  00:4506  57                  	ld		d,a		; D = Final Value for primary slot
     238.  00:4507  78                  	ld		a,b		; Check if expanded
     239.  00:4508  CB 7F               	bit		7,a
     240.  00:450A  28 26               	jr		z,1f	; Not Expanded
     241.  00:450C                      	mainslot_setup	2
     241.  00:450C  E6 03             >  and  3
     241.  00:450E  0F 0F             > [2] rrca
     241.  00:4510  E6 C0             >  and  0xC0
     241.  00:4512  4F                >  ld  c,a
     241.  00:4513  7A                >  ld  a,d
     241.  00:4514  E6 3F             >  and  0x3F
     241.  00:4516  B1                >  or  c
     241.  00:4517  4F                >  ld  c,a
     241.  00:4518                    > 
     241.  00:4518  78                >  ld  a,b
     241.  00:4519  E6 0C             >  and  0x0C
     241.  00:451B  0F 0F             > [2] rrca
     241.  00:451D  E6 03             >  and  3
     241.  00:451F  47                >  ld  b,a
     241.  00:4520  79                >  ld  a,c
     241.  00:4521  D3 A8             >  out  (0A8h),a
     241.  00:4523  3A FF FF          >  ld  a,(0FFFFh)
     241.  00:4526  2F                >  cpl
     241.  00:4527                    >  if (n<=4)
     241.  00:4527  07 07             > [n] RLCA
     241.  00:4529                    >  else
     241.  00:4529                    ~ [8-n] RRCA
     241.  00:4529                    ~  endif
     241.  00:4529  E6 FC             >  and  0xFC
     241.  00:452B  B0                >  or  b
     241.  00:452C                    >  if (n<=4)
     241.  00:452C  0F 0F             > [n] RRCA
     241.  00:452E                    >  else
     241.  00:452E                    ~ [8-n] RLCA
     241.  00:452E                    ~  endif
     241.  00:452E  32 FF FF          >  ld  (0FFFFh),a
     241.  00:4531  47                >  ld  b,a
     242.  00:4532  7A                  1:	ld		a,d				; A = Final value
     243.  00:4533  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     244.  00:4535  C9                  	ret
     540   00:4536                               include sccdetec.asm
       1.  00:4536                      
       2.  00:4536                       ; ====================
       3.  00:4536                       ;    Initialization
       4.  00:4536                       ; ====================
       5.  00:4536                      SCCsearch
       6.  00:4536  21 6B 45             	ld	hl,begin
       7.  00:4539  11 00 C0             	ld	de,0C000H
       8.  00:453C  01 7E 00             	ld	bc,end-begin+1
       9.  00:453F  ED B0                	ldir
      10.  00:4541  CD 00 C0             	call	0C000H
      11.  00:4544  78                   	ld	a,b
      12.  00:4545  32 10 D0             	ld	(SCC),a
      13.  00:4548  C9                   	ret
      14.  00:4549                       
      15.  00:4549                       ; SLOT            .db     0
      16.  00:4549                       ; PAGE1RAM        .db     0
      17.  00:4549                       ; RAMSLOT         .db     0
      18.  00:4549                       
      19.  00:4549                       ; SCC             .db     0
      20.  00:4549                       ; SUB             .db     0FFH
      21.  00:4549                       
      22.  00:4549                       
      23.  00:4549                      en_scc:
      24.  00:4549  3A 10 D0            	ld	a,[SCC]
      25.  00:454C  3C                  	inc	a
      26.  00:454D  C8                  	ret	z			; no scc
      27.  00:454E                      	; ld	a,(0xFFFF)
      28.  00:454E                      	; cpl
      29.  00:454E                      	; ld	(cursubslots),a
      30.  00:454E  DB A8               	in	a,(0xA8)	; Leemos el registro principal de slots
      31.  00:4550  32 12 D0            	ld	(curslot),a	; save it
      32.  00:4553  5F                  	ld	e,a
      33.  00:4554  3A 10 D0            	ld	a,(SCC)
      34.  00:4557  E6 03               	and	0x03		; Nos fijamos en el slot primario
      35.  00:4559  87 87 87 87         [4]	add	a,a
      36.  00:455D  57                  	ld	d,a
      37.  00:455E  7B                  	ld	a,e			; registro principal de slots
      38.  00:455F  E6 CF               	and	11001111b
      39.  00:4561  B2                  	or	d
      40.  00:4562  D3 A8               	out (0xA8),a
      41.  00:4564                      	; ld	(sccslots),a
      42.  00:4564                      	; ld	a,(0xFFFF)
      43.  00:4564                      	; cpl
      44.  00:4564                      	; ld	(sccsubslots),a
      45.  00:4564  C9                  	ret
      46.  00:4565                      	
      47.  00:4565                      en_slot:
      48.  00:4565  3A 12 D0            	ld	a,(curslot)
      49.  00:4568  D3 A8               	out (0xA8),a
      50.  00:456A                      	; ld	a,(cursubslots)
      51.  00:456A                      	; ld	(0xFFFF),a
      52.  00:456A  C9                  	ret
      53.  00:456B                      
      54.  00:456B                      
      55.  00:456B                      ;------------------------------------------------------------
      56.  00:456B                      ; SCC-search v1.0
      57.  00:456B                      ; by Alwin Henseler
      58.  00:456B                      ; using method described in bulletin # 18 MSX-club Enschede
      59.  00:456B                      ; input: none
      60.  00:456B                      ; output: B=slot that contains SCC (=255 if no SCC found)
      61.  00:456B                      
      62.  00:456B  (00:0024)           enaslt:          equ #0024
      63.  00:456B  (00:FCC1)           exptbl:          equ #fcc1
      64.  00:456B  (00:FCC5)           slttbl:          equ #fcc5
      65.  00:456B                      
      66.  00:456B                      begin:
      67.  00:456B  (C000)              	MAP #c000
      68.  00:456B  DB A8               	in a,(#a8)        ; read prim. slotregister
      69.  00:456D  1F                  	rra
      70.  00:456E  1F                  	rra
      71.  00:456F  1F                  	rra
      72.  00:4570  1F                  	rra
      73.  00:4571  E6 03               	and %00000011     ; A = prim.slot page 2
      74.  00:4573  06 00               	ld b,0
      75.  00:4575  4F                  	ld c,a
      76.  00:4576  21 C1 FC            	ld hl,exptbl
      77.  00:4579  09                  	add hl,bc
      78.  00:457A  CB 7E               	bit 7,(hl)        ; page 2-slot expanded ?
      79.  00:457C  28 0C               	jr z,scctest
      80.  00:457E  21 C5 FC            	ld hl,slttbl
      81.  00:4581  09                  	add hl,bc
      82.  00:4582  7E                  	ld a,(hl)         ; A = sec.sel.reg. of page 2-slot
      83.  00:4583  1F                  	rra
      84.  00:4584  1F                  	rra
      85.  00:4585  E6 0C               	and %00001100     ; bit 1/2 = sec.slot page 2
      86.  00:4587  B1                  	or c
      87.  00:4588  CB FF               	set 7,a           ; compose sec.slot-code
      88.  00:458A                      scctest:
      89.  00:458A  F5                  	push af           ; save page 2-slot on the stack
      90.  00:458B  3A C1 FC            	ld a,(exptbl)     ; 1st slot to test
      91.  00:458E                      
      92.  00:458E                      testslot:        
      93.  00:458E  F5                  	push af           ; save test-slot on the stack
      94.  00:458F  26 80               	ld h,#80
      95.  00:4591  CD 24 00            	call enaslt       ; switch slot-to-test in 8000-bfffh
      96.  00:4594  21 00 90            	ld hl,#9000
      97.  00:4597  46                  	ld b,(hl)         ; save contents of address 9000h
      98.  00:4598  36 3F               	ld (hl),#3f       ; activate SCC (if present)
      99.  00:459A                      
     100.  00:459A  AF                  	xor	a
     101.  00:459B  32 FE BF            	ld (0xbffe),a	  ; scc+ patch for bluemsx
     102.  00:459E                      
     103.  00:459E  26 9C               	ld h,#9c          ; address of SCC-register mirrors
     104.  00:45A0  11 00 98            	ld de,#9800       ; 9800h = address of SCC-registers
     105.  00:45A3                      testreg:         
     106.  00:45A3  1A                  	ld a,(de)
     107.  00:45A4  4F                  	ld c,a            ; save contents of address 98xxh
     108.  00:45A5  7E                  	ld a,(hl)         ; read byte from address 9cxxh
     109.  00:45A6  2F                  	cpl               ; and invert it
     110.  00:45A7  12                  	ld (de),a         ; write inverted byte to 98xxh
     111.  00:45A8  BE                  	cp (hl)           ; same value on 9cxxh ?
     112.  00:45A9  79                  	ld a,c
     113.  00:45AA  12                  	ld (de),a         ; restore value on 98xxh
     114.  00:45AB  20 0D               	jr nz,nextslot    ; unequal -> no SCC -> continue search
     115.  00:45AD  23                  	inc hl
     116.  00:45AE  13                  	inc de            ; next test-addresses
     117.  00:45AF  CB 7D               	bit 7,l           ; 128 addresses (registers) tested ?
     118.  00:45B1  28 F0               	jr z,testreg      ; no -> repeat mirror-test
     119.  00:45B3  78                  	ld a,b
     120.  00:45B4  32 00 90            	ld (#9000),a      ; restore value on 9000h
     121.  00:45B7  C1                  	pop bc            ; retrieve slotcode (=SCC-slot) from stack
     122.  00:45B8  18 24               	jr done           ; SCC found, restore page 2-slot & return
     123.  00:45BA                      
     124.  00:45BA                      nextslot:
     125.  00:45BA  78                  	ld a,b
     126.  00:45BB  32 00 90            	ld (#9000),a      ; restore value on 9000h
     127.  00:45BE  C1                  	pop bc            ; retrieve slotcode from stack
     128.  00:45BF  CB 78               	bit 7,b           ; test-slot = sec.slot ?
     129.  00:45C1  28 07               	jr z,nextprim
     130.  00:45C3  78                  	ld a,b
     131.  00:45C4  C6 04               	add a,4           ; increase sec.slotnumber
     132.  00:45C6  CB 67               	bit 4,a           ; sec.slot = 4 ?
     133.  00:45C8  28 C4               	jr z,testslot
     134.  00:45CA                      nextprim:
     135.  00:45CA  78                  	ld a,b
     136.  00:45CB  E6 03               	and %00000011
     137.  00:45CD  FE 03               	cp 3              ; prim.slot = 3 ?
     138.  00:45CF  28 0B               	jr z,noscc
     139.  00:45D1  3C                  	inc a             ; increase prim.slotnumber
     140.  00:45D2  16 00               	ld d,0
     141.  00:45D4  5F                  	ld e,a
     142.  00:45D5  21 C1 FC            	ld hl,exptbl
     143.  00:45D8  19                  	add hl,de
     144.  00:45D9  B6                  	or (hl)           ; combine slot-expansion with slotcode
     145.  00:45DA  18 B2               	jr testslot
     146.  00:45DC                      
     147.  00:45DC                      noscc:           
     148.  00:45DC  06 FF               	ld b,255          ; code for no SCC
     149.  00:45DE                      done:            
     150.  00:45DE  F1                  	pop af            ; retrieve page 2-slot from stack
     151.  00:45DF  C5                  	push bc
     152.  00:45E0  26 80               	ld h,#80
     153.  00:45E2  CD 24 00            	call enaslt       ; restore original page 2-slot
     154.  00:45E5  C1                  	pop bc
     155.  00:45E6  FB                  	ei
     156.  00:45E7  C9                  	ret
     157.  00:45E8                      end:
     158.  00:45E8  (0000)              	endmap				 
     159.  00:45E8                      ; -------------------------------------------------------------
     160.  00:45E8                      
     541   00:45E8                      
     542   00:45E8                      ;-------------------------------------
     543   00:45E8                      ; Padding for rom player
     544   00:45E8                      ;-------------------------------------
     545   00:45E8  00 (6680)                   ds	$6000 - $
     546   00:6000                      
     547   00:6000                      
     548   00:6000                      
     549   00:6000                      ;-------------------------------------
     550   00:6000                      ; Sample data
     551   00:6000                      ;-------------------------------------
     552   00:6000                      SAMPLE_START:
     553   00:6000                               include DataTable.asm
       1.  00:6000                      s0_START:
       2.  00:6000  (14A0)                       incbin data0.bin 
       3.  00:74A0                      s0_END:
       4.  00:74A0                      s1_START:
       5.  00:74A0  (8580)                       incbin data1.bin 
       6.  00:FA20                      s1_END:
       7.  00:FA20                      s2_START:
       8.  00:FA20  (7C80)                       incbin data2.bin 
       9.  00!76A0                      s2_END:
      10.  00!76A0                      s3_START:
      11.  00!76A0  (4B00)                       incbin data3.bin 
      12.  00!C1A0                      s3_END:
      13.  00!C1A0                      s4_START:
      14.  00!C1A0  (42C0)                       incbin data4.bin 
      15.  00!0460                      s4_END:
      16.  00!0460                      s5_START:
      17.  00!0460  (4B00)                       incbin data5.bin 
      18.  00!4F60                      s5_END:
      19.  00!4F60                      s6_START:
      20.  00!4F60  (4B00)                       incbin data6.bin 
      21.  00!9A60                      s6_END:
      22.  00!9A60                      s7_START:
      23.  00!9A60  (42C0)                       incbin data7.bin 
      24.  00!DD20                      s7_END:
      25.  00!DD20                      s8_START:
      26.  00!DD20  (7D40)                       incbin data8.bin 
      27.  00!5A60                      s8_END:
      28.  00!5A60                      s9_START:
      29.  00!5A60  (5E20)                       incbin data9.bin 
      30.  00!B880                      s9_END:
      31.  00!B880                      s10_START:
      32.  00!B880  (2400)                       incbin data10.bin 
      33.  00!DC80                      s10_END:
      34.  00!DC80                      s11_START:
      35.  00!DC80  (4B00)                       incbin data11.bin 
      36.  00!2780                      s11_END:
     554   00!2780                      SAMPLE_END:
     555   00!2780                      
     556   00!2780                      
     557   00!2780                      
     558   00!2780                      ;-------------------------------------
     559   00!2780                      ; Padding, align rom image to a power of two.
     560   00!2780                      ;-------------------------------------
     561   00!2780                      
     562   00!2780  (00:3C780)          SAMPLE_LENGTH:  equ SAMPLE_END - SAMPLE_START
     563   00!2780                      
     564   00!2780                      
     565   00!2780                      
SccReplayer3c.asm(566) : Forward reference
     566   00!2780                              IF (SAMPLE_LENGTH <= 6000h)
     567   00!2780                    ~         DS (06000h - SAMPLE_LENGTH)
     568   00!2780                    ~         ELSE
SccReplayer3c.asm(569) : Forward reference
     569   00!2780                              IF (SAMPLE_LENGTH <= 10000h-2000h)
     570   00!2780                    ~         DS (0E000h - SAMPLE_LENGTH)
     571   00!2780                    ~         ELSE
SccReplayer3c.asm(572) : Forward reference
     572   00!2780                              IF (SAMPLE_LENGTH <= 1E000h)
     573   00!2780                    ~         DS (01E000h - SAMPLE_LENGTH)
     574   00!2780                    ~         ELSE
SccReplayer3c.asm(575) : Forward reference
     575   00!2780                              IF (SAMPLE_LENGTH <= 3E000h)
     576   00!2780  00 (6272)                   DS (03E000h - SAMPLE_LENGTH)
     577   00!4000                              ELSE
SccReplayer3c.asm(578) : Forward reference
     578   00!4000                    ~         IF (SAMPLE_LENGTH <= 7E000h)
     579   00!4000                    ~         DS (07E000h - SAMPLE_LENGTH)
     580   00!4000                    ~         ELSE
     581   00!4000                    ~         DS (0FE000h - SAMPLE_LENGTH)
     582   00!4000                    ~         ENDIF
     583   00!4000                    ~         ENDIF
     584   00!4000                              ENDIF
     585   00!4000                              ENDIF
     586   00!4000                              ENDIF
     587   00!4000                      
     588   00!4000                      
     589   00!4000                      
     590   00!4000                      FINISH:
     591   00!4000                      
     592   00!4000                      
     593   00!4000                      ;---------------------------------------------------------
     594   00!4000                      ; Variables
     595   00!4000                      ;---------------------------------------------------------
     596   00!4000  (00:D000)           VarBase:            equ $D000
     597   00!4000                      
     598   00!4000  (00:D000)           SamplePos:          equ VarBase + 0
     599   00!4000  (00:D002)           SamplePage:         equ VarBase + 2
     600   00!4000  (00:D004)           Period:             equ VarBase + 4
     601   00!4000  (00:D006)           NumBlocksToPlay:    equ VarBase + 6
     602   00!4000  (00:D008)           SccSfxOn:           equ VarBase + 8
     603   00!4000  (00:D00A)           Keys:               equ VarBase + 10
     604   00!4000                      
     605   00!4000  (00:D00C)           slotvar:            equ VarBase + 12
     606   00!4000  (00:D00E)           slotram:            equ VarBase + 14
     607   00!4000  (00:D010)           SCC:            	equ VarBase + 16
     608   00!4000  (00:D012)           curslot:            equ VarBase + 18
     609   00!4000  (00:D013)           sccslots			equ VarBase + 19

    LABELS
-------------------------------------------------
00:00006000   Bank1
00:00006800   Bank2
00:00007000   Bank3
00:00007800   Bank4
00:00009000   sccBank3
00:00004010   START
00:0000408D   START.halt
00:000040B5   effetct24
00:000040DA   message
00:000040EC   instruction_text
00:00004106   scc_slot_text
00:00004111   rom_slot_text
00:0000411C   ram_slot_text
00:00004127   InstallIntHanlder
00:00004134   HandleInt
00:0000413E   ReplayerInit
00:00004166   SfxTable
00:0000000C X nwavs
00:000041A2   ReplayerUpdate
00:000042C8   ReplayerMute
00:000042D0   init_mapper
00:000042E1   PrintNum
00:0000432B   Numbers
00:000008BC X Period50
00:00000749   Period60
00:0000433B   SccAdjust
00:00004354   SccAdjust.counter
00:00004369   SccAdjust.loop
00:00004387   SccAdjust.end
00:0000438B   SccInit
00:000043BB   SccMute
00:000000A8 X i8255porta
00:000000A9   i8255portb
00:000000AA   i8255portc
00:000000AB X i8255portd
00:000043C9   checkkbd
00:00000024 X ENASLT
00:00000138   RSLREG
00:0000013B X WSLREG
00:0000FCC1   EXPTBL
00:000043D4   search_slot
00:000043F3   search_slotram
00:00004414   search_slotram0
00:00004419 X setrompage0
00:0000441F X setrompage2
00:00004425 X setrampage2
00:0000442B X setrompage3
00:00004431 X setrampage3
00:00004437 X recbios
00:0000443A   setslotpage0
00:00004471 X setslotpage1
00:000044B0   setslotpage2
00:000044F7   setslotpage3
00:00004536   SCCsearch
00:00004549   en_scc
00:00004565 X en_slot
00:00000024   enaslt
00:0000FCC1   exptbl
00:0000FCC5   slttbl
00:0000456B   begin
00:0000458A   scctest
00:0000458E   testslot
00:000045A3   testreg
00:000045BA   nextslot
00:000045CA   nextprim
00:000045DC   noscc
00:000045DE   done
00:000045E8   end
00:00006000   SAMPLE_START
00:00006000   s0_START
00:000074A0   s0_END
00:000074A0   s1_START
00:0000FA20   s1_END
00:0000FA20   s2_START
00:000176A0   s2_END
00:000176A0   s3_START
00:0001C1A0   s3_END
00:0001C1A0   s4_START
00:00020460   s4_END
00:00020460   s5_START
00:00024F60   s5_END
00:00024F60   s6_START
00:00029A60   s6_END
00:00029A60   s7_START
00:0002DD20   s7_END
00:0002DD20   s8_START
00:00035A60   s8_END
00:00035A60   s9_START
00:0003B880   s9_END
00:0003B880   s10_START
00:0003DC80   s10_END
00:0003DC80   s11_START
00:00042780   s11_END
00:00042780   SAMPLE_END
00:0003C780   SAMPLE_LENGTH
00:00044000 X FINISH
00:0000D000   VarBase
00:0000D000   SamplePos
00:0000D002   SamplePage
00:0000D004   Period
00:0000D006   NumBlocksToPlay
00:0000D008   SccSfxOn
00:0000D00A X Keys
00:0000D00C   slotvar
00:0000D00E   slotram
00:0000D010   SCC
00:0000D012   curslot
00:0000D013 X sccslots


 Output: SccReplayer3c.out
-------------------------------------------------

 Page: 00
  Org: 00004000  Size: *  Used: 00000000

    No output

 Output: sccplay3c.rom
-------------------------------------------------

 Page: 00
  Org: 00004000  Size: *  Used: 00040000

   Address   Length Align   Label
   00004000  262144         START
